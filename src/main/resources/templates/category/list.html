<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Yummy - ë¶„ë¥˜ë³„ ë ˆì‹œí”¼</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> 
    <style>
        .nav-links { margin-bottom: 20px; text-align: right; }
        .nav-links a { margin-left: 15px; text-decoration: none; color: #555; font-weight: bold; }
        
        .category-group { margin-bottom: 20px; border: 1px solid #ddd; padding: 15px; border-radius: 5px; }
        .category-group h4 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 10px;}
        
        .cat-btn { 
            display: inline-block; padding: 8px 15px; margin: 5px; 
            border: 1px solid #ccc; border-radius: 20px; 
            background: white; color: #333; cursor: pointer; font-size: 14px;
            transition: all 0.2s; 
        }
        .cat-btn:hover { background-color: #f0f0f0; }
        
        /* ì„ íƒëœ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .cat-btn.active { 
            background-color: #007bff; 
            color: white; 
            border-color: #007bff; 
            font-weight: bold; 
        }
        
        .recipe-item { 
            border-bottom: 1px solid #eee; 
            padding: 15px 10px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            transition: background-color 0.2s;
        }
        .recipe-item:hover { background-color: #f9f9f9; }

        .recipe-info { flex-grow: 1; cursor: pointer; }
        .recipe-title { font-size: 1.2em; font-weight: bold; color: #333; text-decoration: none; display: block; margin-bottom: 5px; }
        .recipe-meta { font-size: 0.9em; color: #666; }
        
        .favorite-btn { 
            border: 1px solid #ccc; background: white; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-left: 10px;
        }
    </style>
</head>
<body>

    <th:block th:insert="~{modules/header :: headerFragment}" />


    <h2>ë¶„ë¥˜ë³„ ë ˆì‹œí”¼ ë³´ê¸°</h2>

    <div class="category-group">
        <h4>ì¢…ë¥˜ë³„</h4>
        <button type="button" class="cat-btn" 
                th:each="cat : ${typeCategories}" 
                th:classappend="${selectedTypeCatId == cat.id} ? 'active' : ''"
                th:text="${cat.name}"
                th:onclick="'goType(' + ${cat.id} + ')'"></button>
    </div>

    <div class="category-group">
        <h4>ë°©ë²•ë³„</h4>
        <button type="button" class="cat-btn" 
                th:each="cat : ${methodCategories}" 
                th:classappend="${selectedMethodCatId == cat.id} ? 'active' : ''"
                th:text="${cat.name}"
                th:onclick="'goMethod(' + ${cat.id} + ')'"></button>
    </div>

    <hr>

    <h3>ë ˆì‹œí”¼ ëª©ë¡</h3>
    
    <div th:if="${recipeList != null and !recipeList.empty}">
        <div th:each="recipe : ${recipeList}" class="recipe-item">
            <div class="recipe-info" 
                 th:onclick="|location.href='@{/recipe/detail/{id}(id=${recipe.recipeId})}'|">
                <span class="recipe-title" th:text="${recipe.name}">ë ˆì‹œí”¼ ëª…</span>
                <div class="recipe-meta">
                    â± <span th:text="${recipe.time}"></span>ë¶„ | 
                    ğŸ‘¤ <span th:text="${recipe.serving}"></span>ì¸ë¶„
                </div>
            </div>
            <button th:attr="data-recipe-id=${recipe.recipeId}" 
                    class="favorite-btn" 
                    onclick="event.stopPropagation(); toggleFavorite(this)">
                <span th:text="${recipe.isFavorite} ? 'â­ï¸' : 'â­'"></span>
            </button>
        </div>
    </div>
    
    <div th:if="${recipeList == null or recipeList.empty}" style="text-align: center; padding: 30px; color: #888;">
        <p>ì„ íƒí•˜ì‹  ì¡°ê±´ì— í•´ë‹¹í•˜ëŠ” ë ˆì‹œí”¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        
        // í˜„ì¬ ì„ íƒëœ ìƒíƒœë¥¼ JS ë³€ìˆ˜ë¡œ ì €ì¥ (ì—†ìœ¼ë©´ 0)
        const currentTypeCatId = [[${selectedTypeCatId}]] || 0;
        const currentMethodCatId = [[${selectedMethodCatId}]] || 0;

        // 1. ì¢…ë¥˜ë³„ ì¹´í…Œê³ ë¦¬ í´ë¦­ ì‹œ (í† ê¸€)
        function goType(clickedId) {
            let nextId;
            // í´ë¦­í•œ IDê°€ í˜„ì¬ì™€ ê°™ìœ¼ë©´ 0(ì „ì²´)ìœ¼ë¡œ, ë‹¤ë¥´ë©´ í•´ë‹¹ IDë¡œ
            if (clickedId === currentTypeCatId) {
                nextId = 0; 
            } else {
                nextId = clickedId;
            }
            window.location.href = '/category?typeCatId=' + nextId + '&methodCatId=' + currentMethodCatId;
        }

        // 2. ë°©ë²•ë³„ ì¹´í…Œê³ ë¦¬ í´ë¦­ ì‹œ (í† ê¸€)
        function goMethod(clickedId) {
            let nextId;
            // í´ë¦­í•œ IDê°€ í˜„ì¬ì™€ ê°™ìœ¼ë©´ 0(ì „ì²´)ìœ¼ë¡œ, ë‹¤ë¥´ë©´ í•´ë‹¹ IDë¡œ
            if (clickedId === currentMethodCatId) {
                nextId = 0;
            } else {
                nextId = clickedId;
            }
            window.location.href = '/category?typeCatId=' + currentTypeCatId + '&methodCatId=' + nextId;
        }

        // ì¦ê²¨ì°¾ê¸° í† ê¸€ í•¨ìˆ˜
        function toggleFavorite(button) {
            const recipeId = $(button).data('recipe-id');
            $.ajax({
                url: '/recipe/toggleFavorite',
                type: 'POST',
                data: { recipeId: recipeId },
                dataType: 'json',
                success: function(response) {
                    if (response.status === 'UNAUTHORIZED' && response.redirectUrl) {
                        if(confirm(response.message)) window.location.href = response.redirectUrl;
                        return;
                    }
                    if (response.status === 'OK') {
                        alert(response.message);
                        if(response.isFavorite) $(button).text('â­ï¸');
                        else $(button).text('â­');
                    }
                },
                error: function() { alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); }
            });
        }
        /*]]>*/
    </script>
</body>
</html>