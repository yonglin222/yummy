<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Yummy - ë‚˜ì˜ ëƒ‰ì¥ê³ </title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; padding: 20px; background-color: #f9f9f9; }
        
        h2 { text-align: center; margin-bottom: 30px; color: #333; }

        /* ì»¨í…Œì´ë„ˆ */
        .fridge-container { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 20px; 
            justify-content: center;
        }
        
        /* ì„¹ì…˜ ì¹´ë“œ ë””ìì¸ (ê¹”ë”í•œ í°ìƒ‰ ë°•ìŠ¤) */
        .fridge-section {
            flex: 1;
            min-width: 320px;
            max-width: 450px;
            border: 1px solid #e1e1e1;
            border-radius: 12px;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            /* ë†’ì´ ì œí•œì„ ë‘ì–´ ìŠ¤í¬ë¡¤ ìƒê¸°ê²Œ */
            max-height: 800px;
        }

        /* ì„¹ì…˜ í—¤ë” */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .section-title { font-size: 1.2em; font-weight: bold; color: #333; display: flex; align-items: center; gap: 5px; }
        .count-badge { background: #eee; padding: 2px 8px; border-radius: 10px; font-size: 0.8em; color: #555; }
        
        .bulk-del-btn {
            background-color: #ffcccc;
            color: #d63031;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8em;
            cursor: pointer;
            font-weight: bold;
        }
        .bulk-del-btn:hover { background-color: #ffb3b3; }

        /* ì…ë ¥ ì˜ì—­ */
        .input-area {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
        }
        .input-name { flex: 2; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .input-date { flex: 1.2; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85em; }
        .btn-add {
            background-color: #00b894;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 0 12px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-add:hover { background-color: #00a884; }

        /* ë¦¬ìŠ¤íŠ¸ ì˜ì—­ */
        .list-area { 
            flex-grow: 1; 
            overflow-y: auto; /* ë‚´ìš© ë§ìœ¼ë©´ ìŠ¤í¬ë¡¤ */
            padding-right: 5px;
        }

        .ingredient-item {
            display: flex;
            align-items: center;
            padding: 10px 5px;
            border-bottom: 1px solid #f1f1f1;
            transition: background 0.2s;
        }
        .ingredient-item:hover { background-color: #fafafa; }
        .ingredient-item:last-child { border-bottom: none; }
        
        .chk-box { margin-right: 10px; transform: scale(1.2); cursor: pointer; }
        
        .item-info { flex-grow: 1; display: flex; flex-direction: column; width: 100%; }
        
        /* ì´ë¦„ ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ (í‰ì†Œì—” í…ìŠ¤íŠ¸ì²˜ëŸ¼) */
        .edit-name-input {
            border: 1px solid transparent;
            background: transparent;
            font-weight: bold;
            font-size: 1.05em;
            color: #333;
            width: 95%;
            padding: 2px;
            margin-bottom: 2px;
            border-radius: 4px;
        }
        .edit-name-input:hover { background-color: #f0f0f0; }
        .edit-name-input:focus { background-color: #fff; border: 1px solid #00b894; outline: none; }

        /* ë‚ ì§œ ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ */
        .item-date-wrapper { display: flex; align-items: center; gap: 5px; font-size: 0.85em; color: #666; }
        
        .edit-date-input {
            border: 1px solid transparent;
            background: transparent;
            font-family: inherit;
            color: #666;
            cursor: pointer;
            padding: 2px;
            border-radius: 4px;
            width: 120px;
        }
        .edit-date-input:hover { background-color: #f0f0f0; }
        .edit-date-input:focus { border: 1px solid #007bff; background-color: #fff; outline: none; }
        
        /* ìœ í†µê¸°í•œ ì—†ìŒ ìŠ¤íƒ€ì¼ */
        .no-expiry-style {
            color: #2ecc71;
            font-weight: bold;
            letter-spacing: -0.5px;
        }

        /* D-day ê²½ê³  ìƒ‰ìƒ */
        .warning { color: #d63031; font-weight: bold; font-size: 0.9em; }

        /* ê°œë³„ ì‚­ì œ ë²„íŠ¼ */
        .btn-del-item {
            background: none;
            border: none;
            color: #ccc;
            font-size: 1.2em;
            cursor: pointer;
            padding: 0 5px;
            margin-left: 5px;
        }
        .btn-del-item:hover { color: #ff4d4d; }

        .check-all-label { font-size: 0.8em; display: flex; align-items: center; gap: 3px; cursor: pointer; user-select: none;}
    </style>
</head>
<body>

    <th:block th:insert="~{modules/header :: headerFragment}" />

    <h2>ğŸ¥¦ ë‚˜ì˜ ëƒ‰ì¥ê³ </h2>

    <div class="fridge-container">
        
        <div class="fridge-section" id="section-cold">
            <div class="section-header">
                <div class="section-title">
                    â„ï¸ ëƒ‰ì¥ <span class="count-badge" id="count-ëƒ‰ì¥">0</span>
                </div>
                <div>
                    <label class="check-all-label">
                        <input type="checkbox" class="chk-all" data-target="list-cold"> ì „ì²´
                    </label>
                    <button type="button" class="bulk-del-btn" onclick="deleteSelected('list-cold')">ì„ íƒ ì‚­ì œ</button>
                </div>
            </div>
            
            <div class="input-area">
                <input type="text" class="input-name" id="name-ëƒ‰ì¥" placeholder="ì¬ë£Œ ì…ë ¥ (Enter)" onkeydown="checkEnter(event, 'ëƒ‰ì¥', 'name-ëƒ‰ì¥', 'date-ëƒ‰ì¥')">
                <input type="date" class="input-date" id="date-ëƒ‰ì¥">
                <button type="button" class="btn-add" onclick="registIngredient('ëƒ‰ì¥', 'name-ëƒ‰ì¥', 'date-ëƒ‰ì¥')">+</button>
            </div>

            <div class="list-area" id="list-cold"></div>
        </div>

        <div class="fridge-section" id="section-frozen">
            <div class="section-header">
                <div class="section-title">
                    ğŸ§Š ëƒ‰ë™ <span class="count-badge" id="count-ëƒ‰ë™">0</span>
                </div>
                <div>
                    <label class="check-all-label">
                        <input type="checkbox" class="chk-all" data-target="list-frozen"> ì „ì²´
                    </label>
                    <button type="button" class="bulk-del-btn" onclick="deleteSelected('list-frozen')">ì„ íƒ ì‚­ì œ</button>
                </div>
            </div>

            <div class="input-area">
                <input type="text" class="input-name" id="name-ëƒ‰ë™" placeholder="ì¬ë£Œ ì…ë ¥ (Enter)" onkeydown="checkEnter(event, 'ëƒ‰ë™', 'name-ëƒ‰ë™', 'date-ëƒ‰ë™')">
                <input type="date" class="input-date" id="date-ëƒ‰ë™">
                <button type="button" class="btn-add" onclick="registIngredient('ëƒ‰ë™', 'name-ëƒ‰ë™', 'date-ëƒ‰ë™')">+</button>
            </div>

            <div class="list-area" id="list-frozen"></div>
        </div>

        <div class="fridge-section" id="section-room">
            <div class="section-header">
                <div class="section-title">
                    ğŸ  ìƒì˜¨ <span class="count-badge" id="count-ìƒì˜¨">0</span>
                </div>
                <div>
                    <label class="check-all-label">
                        <input type="checkbox" class="chk-all" data-target="list-room"> ì „ì²´
                    </label>
                    <button type="button" class="bulk-del-btn" onclick="deleteSelected('list-room')">ì„ íƒ ì‚­ì œ</button>
                </div>
            </div>

            <div class="input-area">
                <input type="text" class="input-name" id="name-ìƒì˜¨" placeholder="ì¬ë£Œ ì…ë ¥ (Enter)" onkeydown="checkEnter(event, 'ìƒì˜¨', 'name-ìƒì˜¨', 'date-ìƒì˜¨')">
                <input type="date" class="input-date" id="date-ìƒì˜¨">
                <button type="button" class="btn-add" onclick="registIngredient('ìƒì˜¨', 'name-ìƒì˜¨', 'date-ìƒì˜¨')">+</button>
            </div>

            <div class="list-area" id="list-room"></div>
        </div>

    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/

        $(document).ready(function() {
            loadFridgeData(); 

            // ì „ì²´ ì„ íƒ ì´ë²¤íŠ¸
            $('.chk-all').on('change', function() {
                const targetListId = $(this).data('target');
                const isChecked = $(this).is(':checked');
                $(`#${targetListId} .chk-box`).prop('checked', isChecked);
            });
        });

        // ì—”í„°í‚¤ ì…ë ¥ ê°ì§€
        function checkEnter(event, category, nameId, dateId) {
            if (event.keyCode === 13) {
                event.preventDefault();
                registIngredient(category, nameId, dateId);
            }
        }

        // ì¬ë£Œ ë“±ë¡
        function registIngredient(category, nameId, dateId) {
            const nameInput = $('#' + nameId);
            const dateInput = $('#' + dateId);
            const ingredient = nameInput.val();
            const expirationDate = dateInput.val();

            if (!ingredient.trim()) {
                nameInput.focus();
                return;
            }

            $.ajax({
                url: '/fridge/registAjax',
                type: 'POST',
                data: {
                    ingredient: ingredient,
                    category: category,
                    expirationDate: expirationDate
                },
                success: function(response) {
                    if (response.status === 'OK') {
                        nameInput.val('');
                        // dateInput.val(''); // ë‚ ì§œëŠ” ê·¸ëŒ€ë¡œ ë‘  (ì—°ì†ì…ë ¥ í¸ì˜)
                        nameInput.focus();
                        loadFridgeData();
                    } else {
                        alert(response.message);
                    }
                },
                error: function() { alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); }
            });
        }

        // ëª©ë¡ ì¡°íšŒ
        function loadFridgeData() {
            $.ajax({
                url: '/fridge/data',
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    renderAllLists(data);
                },
                error: function() { console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨'); }
            });
        }

        function renderAllLists(data) {
            $('#list-cold, #list-frozen, #list-room').empty();
            $('.chk-all').prop('checked', false);

            let cntCold = 0, cntFrozen = 0, cntRoom = 0;

            if (data && data.length > 0) {
                data.forEach(function(item) {
                    let targetId = '';
                    if (item.category === 'ëƒ‰ì¥') { targetId = '#list-cold'; cntCold++; }
                    else if (item.category === 'ëƒ‰ë™') { targetId = '#list-frozen'; cntFrozen++; }
                    else { targetId = '#list-room'; cntRoom++; }

                    // ë‚ ì§œê°€ nullì´ë©´ 'ìœ í†µê¸°í•œ ì—†ìŒ' í‘œì‹œ ë¡œì§
                    let inputType = item.expirationDate ? 'date' : 'text';
                    let inputValue = item.expirationDate ? item.expirationDate : 'ìœ í†µê¸°í•œ ì—†ìŒ';
                    let inputClass = item.expirationDate ? '' : 'no-expiry-style';

                    let ddayHtml = '';
                    if (item.expirationDate && item.dday !== null) {
                        if (item.dday < 0) ddayHtml = `<span class="warning">D+${Math.abs(item.dday)}</span>`;
                        else if (item.dday === 0) ddayHtml = `<span class="warning">ì˜¤ëŠ˜ ë§Œë£Œ</span>`;
                        else if (item.dday <= 3) ddayHtml = `<span class="warning">D-${item.dday}</span>`;
                        else ddayHtml = `D-${item.dday}`;
                    }

                    // HTML ìƒì„±
                    let html = `
                        <div class="ingredient-item">
                            <input type="checkbox" class="chk-box" value="${item.id}">
                            
                            <div class="item-info">
                                <input type="text" class="edit-name-input" 
                                       id="name-${item.id}"
                                       value="${item.ingredient}"
                                       onchange="updateItem(${item.id}, '${item.category}')">
                                
                                <div class="item-date-wrapper">
                                    <input type="${inputType}" 
                                           class="edit-date-input ${inputClass}" 
                                           id="date-${item.id}"
                                           value="${inputValue}" 
                                           onfocus="onDateFocus(this)" 
                                           onblur="onDateBlur(this)"
                                           onchange="updateItem(${item.id}, '${item.category}')">
                                    ${ddayHtml}
                                </div>
                            </div>
                            
                            <button type="button" class="btn-del-item" onclick="removeOne(${item.id})">Ã—</button>
                        </div>
                    `;
                    $(targetId).append(html);
                });
            }

            $('#count-ëƒ‰ì¥').text(cntCold);
            $('#count-ëƒ‰ë™').text(cntFrozen);
            $('#count-ìƒì˜¨').text(cntRoom);
        }

        // í¬ì»¤ìŠ¤ ì‹œ: ë‚ ì§œ ì…ë ¥ì°½ìœ¼ë¡œ ë³€í™˜
        function onDateFocus(input) {
            input.type = 'date';
            if (input.value === 'ìœ í†µê¸°í•œ ì—†ìŒ') {
                input.value = ''; 
                input.classList.remove('no-expiry-style');
            }
        }

        // í¬ì»¤ìŠ¤ í•´ì œ ì‹œ: ë¹„ì–´ìˆìœ¼ë©´ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜
        function onDateBlur(input) {
            if (!input.value) {
                input.type = 'text';
                input.value = 'ìœ í†µê¸°í•œ ì—†ìŒ';
                input.classList.add('no-expiry-style');
            }
        }

        // ìˆ˜ì • (ì´ë¦„ ë˜ëŠ” ë‚ ì§œ)
        function updateItem(id, category) {
            const newName = $('#name-' + id).val();
            let newDate = $('#date-' + id).val();

            if (newDate === 'ìœ í†µê¸°í•œ ì—†ìŒ') {
                newDate = '';
            }

            if (!newName.trim()) {
                alert("ì¬ë£Œëª…ì€ ë¹„ì›Œë‘˜ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                loadFridgeData();
                return;
            }

            $.ajax({
                url: '/fridge/modifyAjax',
                type: 'POST',
                data: {
                    id: id,
                    ingredient: newName,
                    category: category,
                    expirationDate: newDate
                },
                success: function(response) {
                    if (response.status === 'OK') {
                        loadFridgeData();
                    } else {
                        alert("ìˆ˜ì • ì‹¤íŒ¨: " + response.message);
                        loadFridgeData();
                    }
                },
                error: function() {
                    alert("ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                    loadFridgeData();
                }
            });
        }

        // ê°œë³„ ì‚­ì œ
        function removeOne(id) {
            $.ajax({
                url: '/fridge/removeAjax',
                type: 'POST',
                data: { id: id },
                success: function(response) {
                    if (response.status === 'OK') loadFridgeData();
                    else alert(response.message);
                }
            });
        }

        // ì„ íƒ ì‚­ì œ
        function deleteSelected(listId) {
            const checkedIds = $(`#${listId} .chk-box:checked`).map(function() {
                return $(this).val();
            }).get();

            if (checkedIds.length === 0) {
                alert("ì‚­ì œí•  ì¬ë£Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }

            $.ajax({
                url: '/fridge/removeMultipleAjax',
                type: 'POST',
                data: { ids: checkedIds },
                success: function(response) {
                    if (response.status === 'OK') loadFridgeData();
                    else alert(response.message);
                },
                error: function() { alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); }
            });
        }

        /*]]>*/
    </script>
</body>
</html>